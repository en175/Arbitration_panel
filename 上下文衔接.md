# 仲裁组庭 Demo 项目上下文衔接文档 (Context Handover)

> **适用场景**：开启新对话时，请让 AI 助手按顺序阅读并理解以下 3 份文档，再开始生成/回答，确保业务规则与产出一致：
> 1) `上下文衔接.md`（本文件）
> 2) `需求文档/第四章-仲裁庭.md`（规则依据与期限口径）
> 3) `需求文档/新版仲裁组庭-PRD.md`（产品定义与流程节点）

**对话约定**
- AI 每次回答的第一句话必须称呼我为 **Yela**（用于校验是否脱离上下文）。
- AI 需要通过多提问来理解需求；每次对话在动手开发/改代码前，必须先向我确认方案范围，且只有在我明确下达“可以开干/开始改/动手”等指令后才开始执行。

## 1. 项目概况
- **项目名称**：广州仲裁委·新版仲裁组庭
- **目标**：构建一个符合真实业务逻辑、具备“权威信赖风”UI 的仲裁组庭工作台演示原型。
- **技术栈**：Vue 3 + Vite（当前已集成 Element Plus，但组件选型不受其风格束缚）

## 2. 核心架构与设计

### 2.1 UI 设计风格
- **主题**：权威信赖风 (Authority & Trust)。
- **主色调**：
  - Primary (深蓝): `#1E3A8A` (用于顶栏、主按钮)
  - Accent (金色): `#B45309` (用于高亮、重要标签)
- **字体**：标题使用衬线体 (EB Garamond/Songti)，正文使用无衬线体。
- **布局**：
  1. **Top Bar**: 品牌标识 + 案件信息（案号 | 案由 | 标的额）。
  2. **Branch Map**: 顶部固定“分支图画布导航”，用于理解流程并点击跳转节点页面（支持拖拽平移/缩放/滚动条）。
  3. **Workspace**: 下方动态加载对应节点的业务组件（统一显示当前页面视角 `roleLabel`）。

### 2.2 数据与状态管理
- **文件**：`src/views/workbench/composables/useArbitration.js`
- **机制**：
  - `activeNodeId`: 当前查看的节点 ID（控制下方 Workspace 显示）。
  - `timelineNodes`: 节点注册表（用于 `id → title/roleLabel/组件` 映射与演示数据承载；页面不再展示时间轴）。
  - `formationMethod`: 秘书在“组庭启动”选择的组庭方式（用于分支图高亮与后续分支理解）。
  - **全能视角**：不设登录页，用户通过分支图点击节点即可查看不同角色的操作视图。

> 角色切换：`switchRole(role)` 目前支持 `party / secretary / director / arbitrator / dept_head`。

### 2.3 组件与依赖选型
- **组件库/依赖**：可以优先引入合适的新库实现更好的体验与视觉效果，不受 Element Plus 的风格束缚。
- **约束**：引入前先确认项目内是否已有同类能力，避免重复引库；引入后确保 `npm run dev` 可正常运行与预览。

## 3. 已实现功能模块 (Nodes)

组件位于 `src/views/workbench/nodes/`，当前项目里这些节点组件均已存在：

| 组件名 | 业务功能（组件语义） | 备注 |
| :--- | :--- | :--- |
| `NodeStart.vue` | 组庭启动 | 已接入工作台 |
| `NodeNominate.vue` | 边裁选择/选定结果提交展示（演示口径） | 已接入工作台 |
| `NodeSelection.vue` | 首裁产生方式选择（当事人侧） | 已接入工作台 |
| `NodeDisclosure.vue` | 披露与接受（仲裁员端演示） | 工作台已预留映射；当前时间轴未启用 |
| `NodeCheck.vue` | 材料核对（秘书端演示） | 工作台已预留映射；当前时间轴未启用 |
| `NodeReview.vue` | 立案部长审核（审批链演示） | 已接入工作台（当前用作 Node ID=6） |
| `NodeReviewLeadership.vue` | 分管委领导审核（审批链演示） | 已接入工作台（当前用作 Node ID=6.5） |
| `NodeDirector.vue` | 主任选择指定路径 | 已接入工作台（当前用作 Node ID=7） |
| `NodeDistribute.vue` | 主任生成并发送名单 | 已接入工作台（当前用作 Node ID=8） |
| `NodeRanking.vue` | 当事人对推荐名单排序 | 已接入工作台（当前用作 Node ID=9） |
| `NodeResult.vue` | 系统汇总排序结果（中间态） | 已接入工作台（当前用作 Node ID=10） |
| `NodeDirectorDesignate.vue` | 主任最终指定（兜底/冲突处理） | 已接入工作台（当前用作 Node ID=11） |
| `NodeFinish.vue` | 组庭完成 | 已接入工作台（当前用作 Node ID=12） |
| `NodeArbChiefChoose.vue` | 边裁共同选定首裁（两名边裁提交选择） | 已接入工作台（当前用作 Node ID=13） |
| `NodeArbChiefResult.vue` | 边裁选首裁结果（系统判定一致/不一致） | 已接入工作台（当前用作 Node ID=14） |
| `NodeConfirm.vue` | 人选确认（历史版本组件） | 当前未在工作台映射中使用 |

### 3.1 当前工作台节点映射（以代码为准）
- 节点注册表：`src/views/workbench/composables/useArbitration.js` 的 `timelineNodes`
- 渲染映射：`src/views/workbench/ArbitrationWorkbench.vue` 的 `currentNodeComponent`
- 当前新增：Node 13/14（边裁选首裁）已纳入节点映射与分支图跳转

## 4. 关键文件索引
- **入口页面**: `src/views/workbench/ArbitrationWorkbench.vue` (布局容器，负责调度分支图导航与 Node 组件)
- **分支图画布组件**: `src/modules/branch-tree/ArbBranchCanvas.vue`
- **全局样式**: `src/styles/theme-arbitration.css` (定义了 CSS Variables 和 Element Plus 覆盖样式)

## 5. 运行指南
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

## 6. 下一步建议
- 当前演示版已覆盖全流程核心 UI。
- 后续可根据需要添加更多交互细节（如“主任路径决策”中的生成名单算法模拟，或“结果汇总”的动态计算演示）。

---

## 7. 本轮对话新增结论（务必带入新对话）

### 7.0 覆盖区使用说明（给新对话的 AI）
- 新开对话后：请先阅读本文件，再阅读 `需求文档/第四章-仲裁庭.md` 与 `需求文档/新版仲裁组庭-PRD.md`。
- 仅需更新本文件时：只覆盖本章的 **7.6【本次对话覆盖区】**（从 BEGIN 到 END），其他章节不要改。

### 7.1 需求背景与目标
- 在工作台顶部提供“合议庭分支图画布”，用于更直观理解流程并快速跳转到对应节点页面。
- 已决定：时间轴不再展示，分支图作为唯一导航入口。

### 7.2 合议庭定义与关键口径
- 合议庭 = 1 个首席 + 2 个边裁。
- “边裁一致/不一致”口径：同一方可能有多个当事人（如申请人 A/B/C），需要判断该方内部是否形成唯一一致选择。
  - 一致：A/B/C 均选择边裁甲 → 有效。
  - 不一致：A 选甲，B/C 选乙 → 无效，进入“推荐/审批”链路。

### 7.3 分支树产品形态（已确认）
- 范围：仅做“合议庭”分支（不做独任庭分支）。
- 交互：点击分支树节点后，通过 `setActiveNode(id)` 切换工作区；不新增路由页。
- 展示：分支树不展示节点状态，只用于理解与跳转。
- 权限：分支树全员可见，不做权限差异。
- 布局：顶部“分支图画布导航”（300px 高），支持拖拽平移、触摸板横向滑动、滚动条控制与缩放。
- 代码组织：分支树模块放在 `src/modules/` 下单独分模块开发。

### 7.4 页面需要同步改动（已确认）
- 顶部 Banner 的“三人仲裁庭”文案改为“合议庭”。
- `NodeStart.vue`（秘书）新增“选择组庭方式”入口（三种方式按钮）。
- 新增“边裁选首裁”两页：Node 13（边裁共同选定首裁）与 Node 14（系统判定结果）。

### 7.5 流程参考（辅助理解）
- 合议庭流程图（图1）：`需求文档/新合议庭流程.png`。
- 流程骨架参考：`需求文档/2026组庭.pdf`。

### 7.6 【本次对话覆盖区】（新开对话时：直接复制带走；下次更新：只覆盖本区块）
<!-- BEGIN:CONVERSATION_OVERWRITE -->
#### 7.6.1 对话约定（用于校验是否脱离上下文）
- AI 每次回答第一句话必须称呼用户为 Yela。
- 动手开发/改代码前，必须先确认方案范围，且只有在用户明确下达“可以开干/开始改/动手”等指令后才开始执行。

#### 7.6.2 本次对话核心结论（已确认）
- 分支树结构以 `2026组庭.pdf` 为骨架，同时结合 `新合议庭流程.png` 补充判断口径（边裁一致/不一致、限期共同选定等）。
- 分支图主干固定：组庭启动（秘书）→三种方式（当事人双方约定共同选定边裁+首裁 / 当事人委托边裁选择首裁 / 当事人未约定一致）。
- 时间轴已移除，仅保留顶部“分支图画布导航”作为唯一导航入口。
- 分支图是画布形态：拖拽平移、触摸板左右滑动、横竖滚动条、Ctrl/⌘+滚轮缩放、右下角胶囊缩放器；背景渐变与点阵铺满可滚动画布。
- “委托主任选定/委托主任指定”在分支树中点击后：跳转到 Node 7（主任选择指定路径），不等同于代码里 `id=4` 的披露与接受页面。
- “主任确认边裁”在分支树中点击后：跳转到 Node 7。
- “首席确认流程”的落点：跳转到 Node 11（主任最终指定）。
- 树上需要露出“退回”节点（在主任审核处显示可退回到边裁选择）。
- 树上不露出“推荐5人排序名单→当事人排序→系统汇总”这段链路（不展示 8/9/10 的子链条）。
- 分支树点击只做节点跳转，不自动切换全局角色；页面需统一展示“该页面视角（roleLabel）”口径。
- 秘书在 Node 1 选择 `formationMethod` 后，会自动进入 Node 2；分支图会高亮对应方式入口节点。

#### 7.6.3 合议庭分支树（最终口径 vFinal）
- 合议庭（根）
  - 组庭启动（秘书）→ Node 1
  - 三种方式（一级分叉，顺序固定）
    - A 当事人双方约定共同选定边裁+首裁 → 审批链：Node 6（部门负责人审批）→ Node 6.5（分管委领导审批）→ Node 11（主任最终指定/确认）
    - B 当事人委托边裁选择首裁
      - 当事人选择边裁 → Node 2
      - 判断：当事人选择边裁是否一致
        - 一致 → 主任审核（露出“退回”）
          - 主任审核 → Node 7
          - 退回 → Node 2
          - 确认边裁 → 通知边裁限期共同选定首裁 → Node 13
            - 结果一致/不一致由系统在 Node 14 展示，并引导进入 Node 11 或审批链
        - 不一致 → 边裁审批链：Node 6 → Node 6.5 → 主任确认边裁 Node 7 → 通知边裁限期共同选定首裁 Node 13（后续同上）
    - C 当事人未约定一致
      - 当事人选择边裁 → Node 2
      - 当事人选择首裁组成方式（三选一）
        - 委托边裁选定首裁 → 复用方式 B 子流程
        - 双方当事人共同选定 → Node 3
        - 委托主任选定/指定 → Node 7

#### 7.6.4 当前实现要点（便于新对话快速定位代码）
- 页面入口与布局：`src/views/workbench/ArbitrationWorkbench.vue`
- 分支图画布组件：`src/modules/branch-tree/ArbBranchCanvas.vue`
- 节点注册表与演示数据：`src/views/workbench/composables/useArbitration.js`
- 组庭启动选方式：`src/views/workbench/nodes/NodeStart.vue`
- 边裁选首裁（新增）：`src/views/workbench/nodes/NodeArbChiefChoose.vue`（Node 13）、`NodeArbChiefResult.vue`（Node 14）
<!-- END:CONVERSATION_OVERWRITE -->
